<div class="dialog-container" *ngIf="!isLoading; else loadingTpl">
  <header class="dialog-header">
    <div *ngIf="profile as profileData">
      <h2 class="dialog-title">
        {{ profileData.user.name || 'Employee Profile' }}
      </h2>
      <p class="dialog-subtitle">
        Code: {{ profileData.user.code ?? 'N/A' }} |
        Department: {{ profileData.user.department ?? 'N/A' }} |
        Sub Department: {{ profileData.user.sub_department ?? 'N/A' }}
      </p>
    </div>
    <button type="button" class="close-btn" (click)="close()">×</button>
  </header>

  <section class="dialog-section" *ngIf="profile?.vacation_balances?.length; else noBalancesTpl">
    <h3 class="section-title">Current Balances</h3>
    <div class="balance-summary">
      <div class="balance-pill" *ngFor="let balance of profile?.vacation_balances">
        <strong>{{ balance.vacation_type_name || 'Vacation' }}</strong>
        <span>
          Remaining: {{ balance.remaining_days | number:'1.2-2' }} /
          Allocated: {{ balance.allocated_days | number:'1.2-2' }} /
          Used: {{ balance.used_days | number:'1.2-2' }} ({{ balance.year }})
        </span>
      </div>
    </div>
  </section>

  <ng-template #noBalancesTpl>
    <section class="dialog-section">
      <h3 class="section-title">Current Balances</h3>
      <p class="muted">No recorded balances yet.</p>
    </section>
  </ng-template>

  <section class="dialog-section">
    <h3 class="section-title">Payroll &amp; Contract</h3>
    <div class="form-grid compact" [formGroup]="detailGroup">
      <label class="form-field">
        <span>Working Hours / Day</span>
        <input type="number" formControlName="working_hours_day" placeholder="0" />
      </label>
      <label class="form-field">
        <span>Start Time</span>
        <input type="time" formControlName="start_time" />
      </label>
      <label class="form-field">
        <span>End Time</span>
        <input type="time" formControlName="end_time" />
      </label>
      <label class="form-field">
        <span>Employment Type</span>
        <input type="text" formControlName="emp_type" placeholder="Full-time" />
      </label>
      <label class="form-field">
        <span>Hiring Date</span>
        <input type="date" formControlName="hiring_date" />
      </label>
    </div>
  </section>

  <section class="dialog-section">
    <header class="section-header">
      <h3 class="section-title">Vacation Balances</h3>
      <button type="button" class="link-btn" (click)="addBalance()" [disabled]="!canAddMoreBalances()">+ Add balance</button>
    </header>

    <div class="vacation-list" formArrayName="balances">
      <div class="vacation-card" *ngFor="let balance of balances.controls; let i = index" [formGroupName]="i">
        <div class="vacation-card-header">
          <span class="vacation-card-title">
            {{ getVacationTypeName(balance.get('vacation_type_id')?.value) || 'New balance' }}
          </span>
          <button type="button" class="link-btn danger" (click)="removeBalance(i)">Remove</button>
        </div>
        <div class="vacation-grid">
          <label class="form-field type-field">
            <span>Vacation Type</span>
            <select formControlName="vacation_type_id">
              <option [ngValue]="null" disabled>Select type</option>
              <option *ngFor="let option of availableVacationTypes(i)" [ngValue]="option.id">
                {{ option.name }}
              </option>
            </select>
          </label>
          <label class="form-field">
            <span>Allocated Days</span>
            <input type="number" formControlName="allocated_days" />
          </label>
          <label class="form-field">
            <span>Used Days</span>
            <input type="number" formControlName="used_days" />
          </label>
          <div class="year-chip-display">
            Year: {{ currentYear }}
          </div>
          <div class="remaining-indicator">
            Remaining: {{ balance.get('remaining_days')?.value | number:'1.2-2' }}
          </div>
        </div>
      </div>

      <p class="muted" *ngIf="balances.length === 0">
        No vacation balances assigned. Use “Add balance” to configure allowances.
      </p>
    </div>
  </section>

  <footer class="dialog-actions">
    <button type="button" class="btn secondary" (click)="close()">Cancel</button>
    <button type="button" class="btn primary" (click)="save()" [disabled]="isSaving">
      {{ isSaving ? 'Saving...' : 'Save Changes' }}
    </button>
  </footer>
</div>

<ng-template #loadingTpl>
  <div class="loading-state">
    <div class="spinner"></div>
    <p>Loading employee profile...</p>
  </div>
</ng-template>
